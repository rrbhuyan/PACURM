# PACURM

Codes for PACURM R package. 
Reproduces the results in the paper _A Scalable Path Algorithm for Clusterwise Messaging Component Analysis in Digital Communications_

-----------------------------------------------------
Folders with their Descriptions
-----------------------------------------------------
Below are six folders, each accompanied by a brief description of its contents:
1. Code: R codes to clean data, perform PACURM and reproduce tables and figures in the paper.
2. Data: Raw data, as well as the cleaned data produced by our R code. [Download here](https://drive.google.com/drive/folders/1FKlCpdNyR-2kiUkdIi46UXeBwiwMKOKr?usp=drive_link)
3. Functions: R files with functions required for CURM Stage I and Stage II.
4. Output: Intermediary .RDS (R data format) files required for reproducing results.
5. Plots: All the plots in the paper.
6. Structured Results: Final results output by PACURM in structured .xlsx files.


-----------------------------------------------------
Description of files in the *Code* and *Functions* folder
-----------------------------------------------------
##### Set of codes required to perform PACURM
- **CURM1_data_clean.R** and **CURM2_data_clean.R** (*in Code folder*):
These two files take as input the raw data files, 'training_data.txt', 'predict_log.csv' and 'coupon_comp.csv'. They output two files for CURM stage I (one for train and test each), and six files for CURM stage II (three each for train and test).
**The 'Data' folder contains these three raw files and eight processed files (eleven in total).**

- **CURM1.R** and **CURM2.R** (*in Code folder*):
These two codes takes as input the processed data created by CURM1_data_clean.R and CURM2_data_clean.R respectively. 
    - CURM1.R implements MHC as described in Algorithm 1 and outputs two files, one with the model coefficients for stage I and the cluster assigment for training data, while the other output file contains clusteer assignment for the testing data. 
    - CURM2.R implements GSURM as described in Algorithm 2 with four models, URM, CURM.0.1, CURM.0.2 and CURM. It outputs three files for each model, one contains all the fitted model parameters. The other two contain the fitted probabilities based on the logistic model, one for the training data and another for the test data.

- **CURM1_fun.R** and **CURM2_fun.R** (*in Functions folder*):
These two files contain all the subroutine functions required to run CURM1.R and CURM2.R respectively. 

- **PA_CURM1.R** and **PA_CURM2.R** (*in Code folder*):
These two files combined perform the Path Algorithm (PA) part of our method. The first file takes as input the output generated by CURM1.R and outputs the optimal path to merge clusters. PA_CURM2.R takes as input the optimal path to merge clusters and the file generated by CURM2.R, and outputs the model coefficients for Stage II for all clusters starting from G ( number of clusters used to perform CURM) till 2.

##### Set of codes required to reproduce analysis in Section 6
- **CURM1_cluster_summary.R** (*in Code folder*):
Using the cluster assignment based on Stage I, this creates the table of cluster-wise average vales of RFM variables (Tables 4,5 and 9 in the paper).

- **CURM2_comp_effects.R** (*in Code folder*):
This takes as input the fitted model generated in CURM Stage II and outputs the plots with overall effects of messaging components (Figure 3) and a heatmap of effects of messaging components across clusters (Figure 4). This also output the posterior mean and a 95% credible intervals for both overall effects and cluster specific effect of messaging components (Tables A1-A4 in the paper).

- **CURM2_CI_Sigma.R** (*in Code folder*):
This takes as input the fitted model generated in CURM Stage II and outputs the estimated posterior means as well as 95% credible sets for all the coefficients (Tables A5-A8 in the paper). It also outputs the covariance matrix of the random effects as well as the memory parameter for the carry-over effect and dynamic engagement.

- **CURM2_ROC.R** (*in Code folder*):
This takes as input the fitted model generated in CURM Stage II and outputs the AUC values and ROC curves for our four models URM, CURM.0.1, CURM.0.2 and CURM (Table 6 and Figure 5 in the paper).

- **CURM1_under_compare.R** (*in Code folder*):
This performs Stage I of CURM by keeping the overdispersion parameter in the Poisson model fixed as unity. It compares this model with our overdispersed model and provides Tables 7, 8 and Figure 6 in the paper.   

**The 'Plots' folder contains the 'CURM2_comp_effects.R', 'CURM2_ROC.R' and 'CURM1_under_compare.R'.**

-----------------------------------------------------
Description of files in the *Output* folder
-----------------------------------------------------
- **k_means_*i*.RDS** and **k_means_test_*i*.RDS**
These two files are the output from CURM Stage I with *i* clusters i.e. k_means_3.RDS and k_means_test_3.RDS are output generated by CURM1.R with number of clusters set to 3. k_means_*i*. RDS contains the fitted model parameters and the cluster assignment for training data while k_means_test_*i*.RDS contains cluster assignment for testing data.

- **CURM2_modelname_*i*.RDS**, **CURM2_modelname_train_prob_*i*.RDS** and **CURM2_modelname_test_prob_*i*.RDS**
There are 4 different 'modelname' based on the four models URM, CURM_0_1 and CURM_0_2. Similar to the previous file, *i* denotes the number of clusters used. These are the three output files generated by CURM2.R. CURM2_modelname_*i*.RDS contains all the fitted model parameters. CURM2_modelname_train_prob_*i*.RDS and CURM2_modelname_test_prob_*i*.RDS contain the fitted probabilities for the training data and the test data respectively.

- **merge_clust_list_10.RDS**, **PA_curm2_*i*.RDS** and **PA_curm2_model_*i*.csv**
The first file merge_clust_list_10.RDS is the output from PA_CURM1.R and contains the optimal path to merge clusters starting from 10 clusters down to two. PA_curm2_*l*.RDS and PA_curm2_model_*l*.csv for *l* = 9,8,...,2 contains the fitted probabilities and the model respectively based on the stage II updates in the Path Algorithm. These are the files output by PA_CURM2.R.

- **CURM2_modelname_mean_CI_*i*.RDS** and **CURM2_modelname_Sigma_*i*.RDS**
Similiar to above there are 4 different 'modelname' based on the four models URM, CURM_0_1 and CURM_0_2 and *i* denotes the number of clusters. The first file contains the posterior mean estimates and the 95% credible sets for each model and the second file contains the covariance matrix for the random effects. These files are output by CURM2_CI_Sigma.R.

-----------------------------------------------------
Description of files in the *Structured Results* folder
-----------------------------------------------------
For ease presentation, we provide some of the outputs as excel file in this folder. Many of these results have been added directly in the paper.

- **CURM1_coeff.xlsx**
Contains the coefficients of the fitted models as well as the centroids for Stage I of CURM with 3, 5 and 10 distinct clusters.

- **CURM2_open_cross_CI.xlsx** and **CURM2_purc_cross_CI.xlsx**
Contains the crossed effects of clusters and components for both the open and purchase stage. It also contains the 95% credible sets for the crossed effects. Available as Tables A.3 and A.4 in the supplementary material of the paper.

- **CURM2_results_modelname.xlsx**
There are 4 different 'modelname' based on the four models URM, CURM_0_1 and CURM_0_2. This excel file contains the posterior mean estimates of coefficients, 95% credible intervals, estimates of decay parameters as well as covariance of the random effects for the fiited model with 5 clusters.

- **CURM2_results_CURM_10.xlsx**
Posterior mean estimates of coefficients, 95% credible intervals, estimates of decay parameters as well as covariance of the random effects for the fiited CURM model with 10 clusters.

- **PA_CURM2_path_coeff.xlsx**
Contains the estimated coefficients for the Stage II model as the number of clusters decrease form 10 to 2. The two sheets signify the model for the open and purchase stage.
